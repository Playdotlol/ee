<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>XenzGPT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://js.puter.com/v2/"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <div class="w-64 bg-white shadow-md p-4 space-y-4 overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">XenzGPT</h2>
        <button id="newChatBtn" class="text-blue-600">+ New</button>
      </div>
      <div id="chatList" class="space-y-2"></div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col">
      <div class="p-4 border-b flex items-center gap-2">
        <select id="model" class="p-2 border rounded">
          <option value="gpt-4o">GPT-4o</option>
          <option value="gpt-4">GPT-4</option>
          <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
          <option value="dall-e-3">DALL·E 3</option>
        </select>
        <button id="voiceBtn" class="ml-auto px-3 py-1 bg-purple-600 text-white rounded">🎤 Voice</button>
      </div>

      <div id="chat" class="flex-1 overflow-y-auto p-4 space-y-4"></div>

      <div class="p-4 border-t">
        <textarea
          id="input"
          rows="2"
          placeholder="Type your message..."
          class="w-full p-2 border rounded mb-2 resize-none"
        ></textarea>
        <button id="sendBtn" class="w-full bg-blue-600 text-white p-2 rounded disabled:opacity-50">Send</button>
      </div>
    </div>
  </div>

  <script>
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");
    const chat = document.getElementById("chat");
    const modelSelect = document.getElementById("model");
    const chatList = document.getElementById("chatList");
    const newChatBtn = document.getElementById("newChatBtn");

    let allChats = {};
    let currentChatId = null;

    function newChatSession() {
      const id = Date.now().toString();
      allChats[id] = [];
      currentChatId = id;
      input.disabled = false;
      sendBtn.disabled = false;
      renderChatList();
      renderMessages();
    }

    function renderChatList() {
      chatList.innerHTML = "";
      Object.keys(allChats).forEach(id => {
        const btn = document.createElement("button");
        btn.textContent = `Chat ${id.slice(-4)}`;
        btn.className = `block w-full text-left px-2 py-1 rounded hover:bg-gray-200 ${id === currentChatId ? 'bg-gray-200' : ''}`;
        btn.onclick = () => {
          currentChatId = id;
          renderChatList();
          renderMessages();
        };
        chatList.appendChild(btn);
      });
    }

    function renderMessages() {
      chat.innerHTML = "";
      allChats[currentChatId].forEach(({ role, content, isHTML }) => {
        const div = document.createElement("div");
        div.className = role === "user" ? "text-right" : "text-left";
        div.innerHTML = isHTML
          ? content
          : `<div class="inline-block bg-${role === "user" ? "blue" : "gray"}-200 rounded p-2 max-w-lg">${marked.parse(content)}</div>`;
        chat.appendChild(div);
      });
      chat.scrollTop = chat.scrollHeight;
    }

    async function handleSend() {
      const prompt = input.value.trim();
      if (!prompt || !currentChatId) return;
      const model = modelSelect.value;

      allChats[currentChatId].push({ role: "user", content: prompt });
      renderMessages();
      input.value = "";
      input.disabled = true;
      sendBtn.disabled = true;

      if (model === "dall-e-3") {
        try {
          const imgElement = await puter.ai.txt2img(prompt);
          imgElement.className = "max-w-sm rounded shadow";
          const wrapper = document.createElement("div");
          wrapper.className = "text-left";
          wrapper.appendChild(imgElement);
          chat.appendChild(wrapper);
          allChats[currentChatId].push({ role: "assistant", content: imgElement.outerHTML, isHTML: true });
        } catch (err) {
          allChats[currentChatId].push({ role: "assistant", content: `⚠️ Image generation failed: ${err.message || err}` });
        }
        renderMessages();
        input.disabled = false;
        sendBtn.disabled = false;
        return;
      }

      const stream = await puter.ai.chat({
        messages: [
          { role: "system", content: "You are a helpful assistant." },
          ...allChats[currentChatId].map(({ role, content }) => ({ role, content }))
        ],
        model
      });

      let reply = "";
      for await (const chunk of stream) {
        const delta = chunk.choices?.[0]?.delta?.content;
        if (delta) {
          reply += delta;
          renderMessages();
        }
      }

      allChats[currentChatId].push({ role: "assistant", content: reply });
      renderMessages();
      input.disabled = false;
      sendBtn.disabled = false;
    }

    sendBtn.onclick = handleSend;
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    document.getElementById("voiceBtn").onclick = () => {
      const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      rec.lang = "en-US";
      rec.start();
      rec.onresult = (e) => {
        input.value += e.results[0][0].transcript;
      };
    };

    newChatBtn.onclick = newChatSession;
    newChatSession(); // Start with one chat
  </script>
</body>
</html>
