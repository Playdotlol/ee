<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>XenzGPT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://js.puter.com/v2/"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="bg-gray-100 p-4 min-h-screen">
  <div class="max-w-3xl mx-auto">
    <h1 class="text-3xl font-bold text-blue-600 mb-4">XenzGPT</h1>

    <div class="flex items-center gap-2 mb-3">
      <select id="model" class="p-2 rounded border">
        <option value="gpt-4o">GPT-4o</option>
        <option value="dall-e-3">DALL·E 3</option>
      </select>
      <label class="flex items-center gap-1">
        <input type="checkbox" id="imageToggle" />
        Enable Image Gen
      </label>
      <button id="voiceBtn" class="px-3 py-1 bg-purple-600 text-white rounded">🎤 Voice</button>
    </div>

    <div id="chat" class="bg-white border rounded p-4 h-[400px] overflow-y-auto mb-4 space-y-4"></div>

    <textarea
      id="input"
      rows="3"
      placeholder="Type your message..."
      class="w-full p-2 border rounded mb-2"
    ></textarea>
    <button id="sendBtn" class="w-full bg-blue-600 text-white p-2 rounded">Send</button>
  </div>

  <script>
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");
    const chat = document.getElementById("chat");
    const modelSelect = document.getElementById("model");
    const imageToggle = document.getElementById("imageToggle");

    let messages = [];

    function appendMessage(role, content, isHTML = false) {
      const div = document.createElement("div");
      div.className = role === "user" ? "text-right" : "text-left";
      div.innerHTML = isHTML
        ? content
        : `<div class="inline-block bg-${role === "user" ? "blue" : "gray"}-200 rounded p-2 max-w-lg">${marked.parse(content)}</div>`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    async function handleSend() {
      const prompt = input.value.trim();
      if (!prompt) return;

      const model = modelSelect.value;
      appendMessage("user", prompt);
      input.value = "";

      // Handle DALL-E image generation
      if (imageToggle.checked && model.includes("dall-e")) {
        try {
          const imgElement = await puter.ai.txt2img(prompt);
          const wrapper = document.createElement("div");
          wrapper.className = "text-left";
          wrapper.appendChild(imgElement);
          chat.appendChild(wrapper);
          chat.scrollTop = chat.scrollHeight;
        } catch (err) {
          appendMessage("assistant", `⚠️ Image generation failed: ${err.message || err}`);
        }
        return;
      }

      // Text response from GPT
      const stream = await puter.ai.chat({
        messages: [
          { role: "system", content: "You are a helpful assistant." },
          ...messages,
          { role: "user", content: prompt }
        ],
        model
      });

      let reply = "";
      for await (const chunk of stream) {
        const delta = chunk.choices?.[0]?.delta?.content;
        if (delta) {
          reply += delta;
          appendMessage("assistant", reply);
        }
      }

      messages.push({ role: "user", content: prompt });
      messages.push({ role: "assistant", content: reply });
    }

    sendBtn.onclick = handleSend;

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    // Voice input
    document.getElementById("voiceBtn").onclick = () => {
      const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      rec.lang = "en-US";
      rec.start();
      rec.onresult = (e) => {
        input.value += e.results[0][0].transcript;
      };
    };
  </script>
</body>
</html>
